@model App_de_gestion_de_buget_version2.Models.ViewModels.WalletDashboardViewModel
@{
    ViewData["Title"] = "Mon portefeuille";
    var wallet = ViewBag.Wallet as App_de_gestion_de_buget_version2.Models.Wallet;
}

<h2>@ViewData["Title"]</h2>

@if (wallet == null)
{
    <div class="card">
        <div class="card-body text-center">
            <h4 class="mb-3">Vous n'avez pas encore de portefeuille</h4>
            <p class="text-muted mb-4">Créez votre portefeuille pour commencer à gérer votre budget</p>
            <a class="btn btn-primary" asp-action="Create">Créer mon portefeuille</a>
            <a class="btn btn-outline-secondary" asp-controller="Home" asp-action="Index">Retour</a>
        </div>
    </div>
}
else
{
    <div class="container-fluid">
        <!-- Main Balance Card -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h3 class="mb-2">Solde actuel</h3>
                                <div class="value animate-balance golden-balance" 
                                     data-value="@((wallet.Balance ?? 0).ToString("F2", System.Globalization.CultureInfo.InvariantCulture))"
                                     style="font-size: 3rem;">
                                    @((wallet.Balance ?? 0).ToString("C"))
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <a class="btn btn-primary btn-lg" asp-action="Edit" asp-route-id="@wallet.WalletId">
                                    <i class="bi bi-pencil"></i> Modifier
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Budget Health Dashboard -->
        @if (Model != null)
        {
            <div class="row mb-4">
                <div class="col-12">
                    <h3 class="mb-3">Tableau de bord budgétaire</h3>
                </div>
            </div>

            <div class="row mb-4">
                <!-- Budget Health Status -->
                <div class="col-md-4 mb-3">
                    <div class="dashboard-card">
                        <h3>Santé du budget</h3>
                        <div class="value mb-3 d-flex justify-content-center align-items-center" style="min-height: 160px;">
                            @if (Model.BudgetHealthStatus == "good")
                            {
                                <img src="~/images/gifdotnet1.gif" alt="Statut Excellent" class="img-fluid rounded" style="max-height: 150px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));" />
                            }
                            else
                            {
                                <img src="~/images/gifdotnet2.gif" alt="Statut Critique" class="img-fluid rounded" style="max-height: 150px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));" />
                            }
                        </div>
                        <div class="indicator @Model.BudgetHealthStatus">
                            @if (Model.BudgetHealthStatus == "good")
                            {
                                <text>Excellent</text>
                            }
                            else if (Model.BudgetHealthStatus == "warning")
                            {
                                <text>Attention requise</text>
                            }
                            else
                            {
                                <text>Budget dépassé</text>
                            }
                        </div>
                        <p class="mt-3 mb-0 text-muted" style="font-size: 0.875rem;">
                            Utilisation : @Model.BudgetUsagePercent.ToString("F1")%
                        </p>
                    </div>
                </div>

                <!-- Current Month Budget -->
                <div class="col-md-4 mb-3">
                    <div class="dashboard-card">
                        <h3>Budget du mois</h3>
                        <div class="value text-primary">@Model.CurrentMonthBudget.ToString("C")</div>
                        <div class="mt-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Dépenses</span>
                                <span>@Model.CurrentMonthExpenses.ToString("C")</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar @(Model.BudgetUsagePercent <= 75 ? "bg-success" : Model.BudgetUsagePercent <= 90 ? "bg-warning" : "bg-danger")" 
                                     role="progressbar" 
                                     style="width: @(Math.Min(Model.BudgetUsagePercent, 100))%"
                                     aria-valuenow="@Model.BudgetUsagePercent" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Savings Rate -->
                <div class="col-md-4 mb-3">
                    <div class="dashboard-card">
                        <h3>
                            Taux d'épargne
                            <span data-bs-toggle="tooltip" title="(Revenus - Dépenses) / Revenus * 100">
                                <i class="bi bi-info-circle text-muted" style="font-size: 0.8em; cursor: help;"></i>
                            </span>
                        </h3>
                        <div class="value @(Model.SavingsRate >= 0 ? "text-success" : "text-danger")">
                            @Model.SavingsRate.ToString("F2")%
                        </div>
                        <p class="mt-3 mb-0 text-muted" style="font-size: 0.875rem;">
                            <strong>@DateTime.Now.ToString("MMMM yyyy", new System.Globalization.CultureInfo("fr-FR")) :</strong><br />
                            Revenus : @Model.CurrentMonthIncomes.ToString("C")<br>
                            Dépenses : @Model.CurrentMonthExpenses.ToString("C")
                        </p>
                    </div>
                </div>
            </div>

            <!-- Budget Statistics -->
            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-header">
                            Statistiques budgétaires
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6 text-center">
                                    <div class="value text-primary">@Model.MonthsWithBudget</div>
                                    <p class="text-muted mb-0">Mois avec budget</p>
                                </div>
                                <div class="col-6 text-center">
                                    <div class="value @(Model.MonthsOverBudget > 0 ? "text-danger" : "text-success")">@Model.MonthsOverBudget</div>
                                    <p class="text-muted mb-0">Mois dépassés</p>
                                </div>
                            </div>
                            @if (Model.MonthsWithBudget > 0)
                            {
                                <div class="mt-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Taux de réussite</span>
                                        <span>@(((Model.MonthsWithBudget - Model.MonthsOverBudget) / (double)Model.MonthsWithBudget * 100).ToString("F1"))%</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar bg-success" 
                                             role="progressbar" 
                                             style="width: @(((Model.MonthsWithBudget - Model.MonthsOverBudget) / (double)Model.MonthsWithBudget * 100))%"
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-header">
                            Actions rapides
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a class="btn btn-primary" asp-controller="Budget" asp-action="Index">
                                    Gérer les budgets
                                </a>
                                <a class="btn btn-secondary" asp-controller="Transaction" asp-action="Index">
                                    Voir les transactions
                                </a>
                                <a class="btn btn-info" asp-controller="Report" asp-action="MonthlySummary">
                                    Voir les rapports
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budget Breakdown by Category Chart -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            Répartition du budget par catégorie
                        </div>
                        <div class="card-body">
                            @if (Model.CategoryBreakdown != null && Model.CategoryBreakdown.Any())
                            {
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="chart-container">
                                            <canvas id="budgetCategoryChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h5 class="mb-3">Détails par catégorie</h5>
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Catégorie</th>
                                                    <th>Montant</th>
                                                    <th>% du budget</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var item in Model.CategoryBreakdown)
                                                {
                                                    var budgetPercent = Model.CurrentMonthBudget > 0 ? (item.Total / Model.CurrentMonthBudget) * 100 : 0;
                                                    var expensePercent = Model.CurrentMonthExpenses > 0 ? (item.Total / Model.CurrentMonthExpenses) * 100 : 0;
                                                    <tr>
                                                        <td><strong>@item.CategoryName</strong></td>
                                                        <td>@item.Total.ToString("C")</td>
                                                        <td>
                                                            <div class="d-flex align-items-center">
                                                                <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                                                    <div class="progress-bar @(budgetPercent > 100 ? "bg-danger" : budgetPercent > 75 ? "bg-warning" : "bg-success")" 
                                                                         style="width: @(Math.Min(budgetPercent, 100))%"
                                                                         role="progressbar">
                                                                    </div>
                                                                </div>
                                                                <span>@expensePercent.ToString("F1")%</span>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                        @if (Model.CurrentMonthBudget > 0)
                                        {
                                            <div class="mt-3 p-3 bg-light rounded">
                                                <strong>Budget total:</strong> @Model.CurrentMonthBudget.ToString("C")<br>
                                                <strong>Dépenses totales:</strong> @Model.CurrentMonthExpenses.ToString("C")<br>
                                                <strong>Reste:</strong> 
                                                <span class="@((Model.CurrentMonthBudget - Model.CurrentMonthExpenses) >= 0 ? "text-success" : "text-danger")">
                                                    @((Model.CurrentMonthBudget - Model.CurrentMonthExpenses).ToString("C"))
                                                </span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="chart-container">
                                            <canvas id="budgetCategoryChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h5 class="mb-3">Aperçu du budget</h5>
                                        <p class="text-muted">Aucune dépense catégorisée ce mois-ci.</p>
                                        @if (Model.CurrentMonthBudget > 0)
                                        {
                                            <div class="mt-3 p-3 bg-light rounded">
                                                <strong>Budget total:</strong> @Model.CurrentMonthBudget.ToString("C")<br>
                                                <strong>Dépenses totales:</strong> @Model.CurrentMonthExpenses.ToString("C")<br>
                                                <strong>Reste:</strong> 
                                                <span class="@((Model.CurrentMonthBudget - Model.CurrentMonthExpenses) >= 0 ? "text-success" : "text-danger")">
                                                    @((Model.CurrentMonthBudget - Model.CurrentMonthExpenses).ToString("C"))
                                                </span>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="alert alert-info">
                                                <strong>Info:</strong> Aucun budget défini pour ce mois. Créez un budget pour commencer à suivre vos dépenses.
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Category Budget Alerts -->
            @if (Model.CategoryBudgetAlerts != null && Model.CategoryBudgetAlerts.Any())
            {
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-danger">
                            <div class="card-header bg-danger text-white d-flex align-items-center justify-content-between">
                                <h4 class="mb-0">⚠️ Alertes de dépassement de budget par catégorie</h4>
                                <img src="~/images/gifdotnet2.gif" alt="Alert" style="height: 40px; width: auto; border-radius: 4px;" />
                            </div>
                            <div class="card-body">
                                @foreach (var alert in Model.CategoryBudgetAlerts)
                                {
                                    <div class="alert alert-danger mb-3 d-flex gap-3 align-items-center">
                                        <div class="flex-grow-1">
                                            <h5 class="alert-heading">
                                                <strong>@alert.CategoryName</strong> - Budget dépassé!
                                            </h5>
                                            <hr>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <p class="mb-1">
                                                        <strong>Budget alloué:</strong> @alert.BudgetAmount.ToString("C")
                                                    </p>
                                                    <p class="mb-1">
                                                        <strong>Montant dépensé:</strong> @alert.SpentAmount.ToString("C")
                                                    </p>
                                                </div>
                                                <div class="col-md-6">
                                                    <p class="mb-1">
                                                        <strong>Dépassement:</strong> 
                                                        <span class="text-danger fw-bold">@alert.OverAmount.ToString("C")</span>
                                                    </p>
                                                    <p class="mb-0">
                                                        <strong>Pourcentage de dépassement:</strong> 
                                                        <span class="text-danger fw-bold">@alert.OverPercentage.ToString("F1")%</span>
                                                    </p>
                                                </div>
                                            </div>
                                            <div class="mt-2">
                                                <div class="progress" style="height: 25px;">
                                                    <div class="progress-bar bg-danger" 
                                                         role="progressbar" 
                                                         style="width: @((alert.SpentAmount / alert.BudgetAmount * 100))%"
                                                         aria-valuenow="@alert.SpentAmount" 
                                                         aria-valuemin="0" 
                                                         aria-valuemax="@alert.BudgetAmount">
                                                        @((alert.SpentAmount / alert.BudgetAmount * 100).ToString("F1"))%
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <img src="~/images/gifdotnet2.gif" alt="Critique" style="max-height: 80px; width: auto; border-radius: 8px;" />
                                        </div>
                                    </div>
                                }
                                <div class="alert alert-warning mb-0 d-flex gap-3 align-items-center">
                                    <div class="flex-grow-1">
                                        <strong>⚠️ Attention:</strong> Votre statut de crédit est marqué comme "mauvais" car une ou plusieurs catégories ont dépassé leur budget alloué.
                                    </div>
                                    <div class="flex-shrink-0">
                                        <img src="~/images/gifdotnet2.gif" alt="Critique" style="max-height: 50px; width: auto; border-radius: 4px;" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Budget Health Recommendations -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            Recommandations
                        </div>
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-9">
                                        @if (Model.CategoryBudgetAlerts != null && Model.CategoryBudgetAlerts.Any())
                                        {
                                            <div class="alert alert-danger mb-3">
                                                <strong>❌ Crédit mauvais!</strong> Une ou plusieurs catégories ont dépassé leur budget. 
                                                Veuillez réduire vos dépenses dans ces catégories pour améliorer votre statut financier.
                                            </div>
                                        }
                                        @if (Model.BudgetHealthStatus == "good")
                                        {
                                            <div class="alert alert-success mb-0">
                                                <strong>Excellent travail!</strong> Vous gérez bien votre budget ce mois-ci. Continuez ainsi!
                                            </div>
                                        }
                                        else if (Model.BudgetHealthStatus == "warning")
                                        {
                                            <div class="alert alert-warning mb-0">
                                                <strong>Attention:</strong> Vous avez utilisé @Model.BudgetUsagePercent.ToString("F1")% de votre budget. 
                                                Essayez de réduire vos dépenses pour rester dans les limites.
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="alert alert-danger mb-0">
                                                <strong>Budget dépassé!</strong> Vous avez dépassé votre budget de @((Model.CurrentMonthExpenses - Model.CurrentMonthBudget).ToString("C")). 
                                                Considerez réviser vos dépenses et ajuster votre budget pour le mois prochain.
                                            </div>
                                        }
                                    </div>
                                    <div class="col-md-3 text-center">
                                        @if (Model.BudgetHealthStatus == "good")
                                        {
                                            <img src="~/images/gifdotnet1.gif" alt="Success" class="img-fluid rounded" style="max-height: 120px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));" />
                                        }
                                        else
                                        {
                                            <img src="~/images/gifdotnet2.gif" alt="Alert" class="img-fluid rounded" style="max-height: 120px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));" />
                                        }
                                    </div>
                                </div>
                            </div>
                    </div>
                </div>
            </div>
        }

        <p class="mt-4">
            <a class="btn btn-outline-secondary" asp-controller="Home" asp-action="Index">Retour</a>
        </p>
    </div>
}

@section Scripts {
    @if (Model != null)
    {
        <script>
            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })

            const totalExpenses = @((double)Model.CurrentMonthExpenses);
            const totalBudget = @((double)Model.CurrentMonthBudget);
            
            @if (Model.CategoryBreakdown != null && Model.CategoryBreakdown.Any())
            {
                <text>
                const budgetCategoryData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                    Model.CategoryBreakdown.Select(c => new { 
                        label = c.CategoryName, 
                        value = (double)c.Total,
                        percentage = Model.CurrentMonthExpenses > 0 ? (double)((c.Total / Model.CurrentMonthExpenses) * 100) : 0
                    })
                ));

                // Generate colors for each category
                const colors = [
                    '#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981',
                    '#3b82f6', '#ef4444', '#14b8a6', '#f97316', '#a855f7',
                    '#06b6d4', '#84cc16', '#eab308', '#f43f5e', '#6366f1'
                ];

                const ctx = document.getElementById('budgetCategoryChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: budgetCategoryData.map(c => c.label),
                            datasets: [{
                                data: budgetCategoryData.map(c => c.value),
                                backgroundColor: colors.slice(0, budgetCategoryData.length),
                                borderWidth: 3,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: {
                                        padding: 15,
                                        font: {
                                            size: 12
                                        },
                                        usePointStyle: true
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const percentage = ((value / totalExpenses) * 100).toFixed(1);
                                            const budgetPercent = totalBudget > 0 ? ((value / totalBudget) * 100).toFixed(1) : '0.0';
                                            return label + ': ' + value.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' }) + 
                                                   ' (' + percentage + '% des dépenses, ' + budgetPercent + '% du budget)';
                                        }
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Dépenses par catégorie',
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    },
                                    padding: 20
                                }
                            }
                        }
                    });
                }
                </text>
            }
            else
            {
                <text>
                // Show budget vs expenses chart when no categories
                const ctx = document.getElementById('budgetCategoryChart');
                if (ctx && totalBudget > 0) {
                    const remaining = Math.max(0, totalBudget - totalExpenses);
                    new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: ['Dépenses', 'Reste'],
                            datasets: [{
                                data: [totalExpenses, remaining],
                                backgroundColor: ['#ef4444', '#10b981'],
                                borderWidth: 3,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: {
                                        padding: 15,
                                        font: {
                                            size: 12
                                        },
                                        usePointStyle: true
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const percentage = ((value / totalBudget) * 100).toFixed(1);
                                            return label + ': ' + value.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' }) + 
                                                   ' (' + percentage + '% du budget)';
                                        }
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Budget vs Dépenses',
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    },
                                    padding: 20
                                }
                            }
                        }
                    });
                } else if (ctx) {
                    // No budget defined
                    const ctx2d = ctx.getContext('2d');
                    ctx2d.font = '16px Arial';
                    ctx2d.fillStyle = '#6b7280';
                    ctx2d.textAlign = 'center';
                    ctx2d.fillText('Aucun budget défini', ctx.width / 2, ctx.height / 2);
                }
                </text>
            }
        </script>
    }
}


